<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ÎßàÏùÑ Î™®Ìóò RPG - MyWorld</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #1a1a2e; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: manipulation; }
    canvas { display: block; margin: 0 auto; image-rendering: pixelated; }
    .hidden { display: none !important; }

    /* Title Screen */
    #title-screen {
      position: fixed; inset: 0; z-index: 100;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      color: #fff; padding: 20px; overflow-y: auto;
    }
    #title-screen h1 {
      font-size: 32px;
      background: linear-gradient(90deg, #FFD700, #FFA500, #FF6B35);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-top: 10px; text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    /* Character Customization */
    .custom-section {
      margin: 12px 0; text-align: center;
      background: rgba(255,255,255,0.05); padding: 10px 16px; border-radius: 12px;
    }
    .custom-section label {
      display: block; color: #FFD700; font-size: 13px; margin-bottom: 8px; font-weight: bold;
    }
    .color-picker { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .color-btn {
      width: 32px; height: 32px; border-radius: 50%; border: 3px solid #444;
      cursor: pointer; transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .color-btn:hover { transform: scale(1.2); border-color: #888; }
    .color-btn.selected {
      border-color: #FFD700; box-shadow: 0 0 12px #FFD700, 0 0 24px rgba(255,215,0,0.5);
      transform: scale(1.1);
    }

    .char-select { display: flex; gap: 20px; margin-top: 16px; }
    .char-btn {
      padding: 16px 28px; font-size: 15px;
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.3); border-radius: 16px; color: #fff;
      cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .char-btn:hover {
      background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.2));
      transform: scale(1.08); border-color: #FFD700;
    }
    .char-btn canvas { display: block; margin: 0 auto; }

    /* HUD - ÏÉÅÎã® Í≥†Ï†ï (Í∞úÏÑ†Îêú ÎîîÏûêÏù∏) */
    #hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; gap: 8px; padding: 8px 16px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,40,0.9));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; color: #fff; font-size: 12px; z-index: 20;
      flex-wrap: wrap; justify-content: center; max-width: 95%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .hp-bar, .exp-bar { height: 10px; border-radius: 5px; overflow: hidden; background: #222; border: 1px solid #444; }
    .hp-bar { width: 80px; }
    .exp-bar { width: 60px; height: 6px; }
    .hp-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s; }
    .exp-fill { height: 100%; background: linear-gradient(90deg, #2196F3, #64B5F6); transition: width 0.3s; }

    /* Í≤åÏûÑ ÏòÅÏó≠ - Ï∫îÎ≤ÑÏä§ ÏúÑÏπò Ï°∞Ï†ï */
    #game-container {
      position: fixed; top: 55px; left: 50%; transform: translateX(-50%);
      display: flex; justify-content: center; align-items: center;
      border-radius: 8px; overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    /* Ïª®Ìä∏Î°§ ÏòÅÏó≠ - ÌïòÎã® Í≥†Ï†ï (Ï¢åÏö∞ Î∂ÑÎ¶¨ Î†àÏù¥ÏïÑÏõÉ) */
    #controls {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.8));
      padding: 12px 16px 16px; z-index: 20;
      display: flex; justify-content: space-between; align-items: flex-end;
    }

    /* ÏôºÏ™Ω: D-Pad */
    #dpad-container {
      flex: 0 0 auto;
    }

    /* Í∞ÄÏö¥Îç∞: Îπà Í≥µÍ∞Ñ */
    .control-spacer { flex: 1; }

    /* Ïò§Î•∏Ï™Ω: Î©îÎâ¥ Î≤ÑÌäºÎì§ */
    #menu-container {
      flex: 0 0 auto;
      display: flex; flex-direction: column; gap: 6px; align-items: flex-end;
    }

    /* Î©îÎâ¥ Î≤ÑÌäºÎì§ */
    .menu-row { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
    .menu-btn {
      padding: 10px 14px; font-size: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 10px; color: #fff; cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: all 0.15s ease;
    }
    .menu-btn:hover, .menu-btn:active {
      background: linear-gradient(135deg, rgba(255,255,255,0.35), rgba(255,255,255,0.2));
      transform: scale(1.05);
    }
    .menu-btn.attack {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-color: #c0392b;
      font-weight: bold;
    }
    .menu-btn.home {
      background: linear-gradient(135deg, #27ae60, #1e8449);
      border-color: #1e8449;
    }

    /* D-Pad - Í∞úÏÑ†Îêú ÎîîÏûêÏù∏ */
    #dpad { display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .dpad-row { display: flex; gap: 3px; }
    .dpad-btn {
      width: 48px; height: 48px; font-size: 20px;
      border: 2px solid #666;
      border-radius: 12px;
      background: linear-gradient(135deg, #444, #333);
      color: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center; user-select: none;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
      transition: all 0.1s ease;
    }
    .dpad-btn:active {
      background: linear-gradient(135deg, #666, #555);
      transform: scale(0.95);
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .dpad-spacer { width: 48px; height: 48px; }

    /* Zone info */
    #zone-info {
      position: fixed; top: 48px; left: 50%; transform: translateX(-50%);
      color: #FFD700; font-size: 12px; z-index: 19;
      background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(30,30,50,0.8));
      padding: 4px 14px; border-radius: 12px;
      border: 1px solid rgba(255,215,0,0.3);
      font-weight: bold;
    }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center; z-index: 50;
      backdrop-filter: blur(4px);
    }
    .modal {
      background: linear-gradient(135deg, #1e1e2e, #2a2a3e);
      border-radius: 20px; padding: 20px; max-width: 360px; width: 92%;
      max-height: 70vh; overflow-y: auto; color: #fff;
      border: 2px solid rgba(255,215,0,0.3);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .modal h3 { margin: 0 0 12px; font-size: 18px; text-align: center; color: #FFD700; }
    .modal-close {
      margin-top: 12px; width: 100%; padding: 12px;
      background: linear-gradient(135deg, #555, #444);
      border: none; border-radius: 10px; color: #fff; cursor: pointer; font-size: 14px;
      transition: all 0.2s ease;
    }
    .modal-close:hover { background: linear-gradient(135deg, #666, #555); }

    /* Item Row */
    .item-row {
      display: flex; align-items: center; gap: 10px; padding: 10px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px;
      transition: background 0.2s;
    }
    .item-row:hover { background: rgba(255,255,255,0.05); border-radius: 8px; }
    .item-row .emoji { font-size: 24px; }
    .item-row .info { flex: 1; }
    .item-row .desc { font-size: 11px; color: #888; }
    .sm-btn {
      padding: 6px 12px; font-size: 12px; border: none;
      border-radius: 8px; color: #fff; cursor: pointer;
      transition: all 0.2s; font-weight: bold;
    }
    .sm-btn:hover { transform: scale(1.05); filter: brightness(1.1); }

    /* Zone Select */
    .zone-btn {
      display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.2); border-radius: 12px;
      color: #fff; cursor: pointer; margin-bottom: 8px; text-align: left;
      transition: all 0.2s;
    }
    .zone-btn:hover {
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
      border-color: #FFD700; transform: scale(1.02);
    }

    /* Combat */
    #combat-screen {
      position: fixed; inset: 0; display: flex; flex-direction: column;
      align-items: center; padding: 16px; color: #fff; z-index: 30;
    }
    .combat-log {
      background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(20,20,40,0.7));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 12px;
      margin: 10px 0; width: 300px; max-height: 110px; overflow-y: auto;
    }
    .combat-log div { font-size: 13px; margin-bottom: 4px; color: #ccc; }
    .combat-log div:last-child { color: #FFD700; font-weight: bold; }
    .combat-btns { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
    .action-btn {
      padding: 14px 24px; font-size: 15px; border: none;
      border-radius: 12px; color: #fff; cursor: pointer; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: all 0.2s ease;
    }
    .action-btn:hover { transform: scale(1.05); }
    .action-btn:active { transform: scale(0.98); }

    /* Notification */
    #notification {
      position: fixed; top: 90px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(30,30,50,0.95));
      color: #FFD700; padding: 10px 24px;
      border-radius: 20px; font-size: 14px; z-index: 200; white-space: nowrap;
      border: 2px solid rgba(255,215,0,0.4);
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      font-weight: bold;
      animation: notifPop 0.3s ease-out;
    }
    @keyframes notifPop {
      0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    /* Saved characters */
    .saved-chars-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 12px 0; }
    .saved-char-card {
      display: flex; flex-direction: column; align-items: center;
      padding: 12px 18px;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.2); border-radius: 14px;
      cursor: pointer; transition: all 0.2s; color: #fff; position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .saved-char-card:hover {
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
      border-color: #FFD700; transform: scale(1.05);
    }
    .saved-char-card .char-name { font-weight: bold; font-size: 13px; color: #FFD700; margin-top: 6px; }
    .saved-char-card .char-info { font-size: 11px; color: #aaa; }
    .delete-char-btn {
      position: absolute; top: -8px; right: -8px; width: 22px; height: 22px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border: 2px solid #fff; border-radius: 50%; color: #fff;
      font-size: 14px; cursor: pointer; display: none; line-height: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .saved-char-card:hover .delete-char-btn { display: block; }

    /* Damage numbers */
    .damage-number {
      position: fixed; pointer-events: none; z-index: 100;
      font-size: 16px; font-weight: bold;
      text-shadow: 2px 2px 0 #000;
      animation: damageFloat 0.8s ease-out forwards;
    }
    @keyframes damageFloat {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-25px); opacity: 0; }
    }

    /* Quiz Modal */
    .quiz-input {
      width: 100px; padding: 14px; font-size: 24px; text-align: center;
      border-radius: 12px; border: 3px solid #FFD700; background: #2a2a3e; color: #fff;
      margin: 15px auto; display: block;
      box-shadow: 0 4px 12px rgba(255,215,0,0.3);
    }
    .quiz-input:focus { outline: none; border-color: #FFA500; }
    .quiz-question {
      font-size: 32px; text-align: center; margin: 20px 0; color: #FFD700;
      text-shadow: 0 2px 8px rgba(255,215,0,0.3);
    }
    .quiz-btn {
      padding: 14px 36px; font-size: 18px; border: none; border-radius: 12px;
      background: linear-gradient(135deg, #27ae60, #1e8449);
      color: #fff; cursor: pointer; margin: 8px;
      box-shadow: 0 4px 12px rgba(39,174,96,0.4);
      transition: all 0.2s ease; font-weight: bold;
    }
    .quiz-btn:hover { transform: scale(1.05); }

    /* Secret portal sparkle */
    @keyframes sparkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    @keyframes portalGlow {
      0%, 100% { box-shadow: 0 0 10px #FFD700, 0 0 20px #9400D3; }
      50% { box-shadow: 0 0 20px #FFD700, 0 0 40px #9400D3; }
    }

    /* Ingredient tags */
    .ingredient-tag {
      font-size: 11px; padding: 4px 8px; background: rgba(255,255,255,0.08);
      border-radius: 6px; display: inline-block; margin: 2px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .has-enough { color: #4CAF50; border-color: rgba(76,175,80,0.3); background: rgba(76,175,80,0.1); }
    .not-enough { color: #f44336; border-color: rgba(244,67,54,0.3); background: rgba(244,67,54,0.1); }
  </style>
</head>
<body>

<!-- Title Screen -->
<div id="title-screen">
  <div style="font-size:36px; margin-bottom:4px">üè∞</div>
  <h1>ÎßàÏùÑ Î™®Ìóò RPG</h1>
  <p style="color:#aaa; font-size:12px; margin-bottom:10px">Village Adventure - MyWorld</p>

  <!-- Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù -->
  <div id="saved-chars"></div>

  <!-- ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Í∏∞ -->
  <div id="new-char-section" style="margin-top:10px;">
    <p style="color:#fff; font-size:14px; margin-bottom:8px">üÜï ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Í∏∞</p>
    <input type="text" id="char-name-input" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="8"
      style="padding:8px 12px; font-size:14px; border-radius:8px; border:2px solid #555; background:#2a2a3e; color:#fff; width:150px; text-align:center; margin-bottom:10px;">

    <!-- ÏÉâÏÉÅ ÏÑ†ÌÉù -->
    <div class="custom-section">
      <label>Î®∏Î¶¨ÏÉâ</label>
      <div class="color-picker" id="hair-colors"></div>
    </div>
    <div class="custom-section">
      <label>Ïò∑ ÏÉâÏÉÅ</label>
      <div class="color-picker" id="clothes-colors"></div>
    </div>
    <div class="custom-section">
      <label>Ïã†Î∞ú ÏÉâÏÉÅ</label>
      <div class="color-picker" id="shoes-colors"></div>
    </div>

    <!-- Ï∫êÎ¶≠ÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞ Î∞è ÏÑ†ÌÉù -->
    <div class="char-select">
      <button class="char-btn" onclick="createNewChar('boy')">
        <canvas id="char-preview-boy" width="48" height="48" style="image-rendering:pixelated;"></canvas>
        <span style="font-size:12px">ÏÜåÎÖÑ</span>
      </button>
      <button class="char-btn" onclick="createNewChar('girl')">
        <canvas id="char-preview-girl" width="48" height="48" style="image-rendering:pixelated;"></canvas>
        <span style="font-size:12px">ÏÜåÎÖÄ</span>
      </button>
    </div>
  </div>
  <p style="color:#666; margin-top:15px; font-size:11px">Î∞©Ìñ•ÌÇ§/WASD Ïù¥Îèô | Space Í≥µÍ≤©</p>
</div>

<!-- Game Container -->
<div id="game-container" class="hidden">
  <canvas id="game"></canvas>
</div>

<!-- HUD -->
<div id="hud" class="hidden">
  <span id="hud-name" style="color:#FFF; font-weight:bold"></span>
  <span id="hud-level" style="color:#FFD700"></span>
  <span style="color:#f66">‚ù§Ô∏è<span id="hud-hp"></span></span>
  <div class="hp-bar"><div class="hp-fill" id="hud-hp-bar"></div></div>
  <span style="color:#6af; font-size:10px">EXP</span>
  <div class="exp-bar"><div class="exp-fill" id="hud-exp-bar"></div></div>
  <span id="hud-gold" style="color:#FFD700"></span>
  <span id="hud-stats" style="color:#ccc"></span>
</div>

<!-- Zone Info -->
<div id="zone-info" class="hidden"></div>

<!-- Controls Area - Ï¢åÏö∞ Î∂ÑÎ¶¨ Î†àÏù¥ÏïÑÏõÉ -->
<div id="controls" class="hidden">
  <!-- ÏôºÏ™Ω: D-Pad -->
  <div id="dpad-container">
    <div id="dpad">
      <button class="dpad-btn" onclick="movePlayer(0,-1)">‚ñ≤</button>
      <div class="dpad-row">
        <button class="dpad-btn" onclick="movePlayer(-1,0)">‚óÄ</button>
        <div class="dpad-spacer"></div>
        <button class="dpad-btn" onclick="movePlayer(1,0)">‚ñ∂</button>
      </div>
      <button class="dpad-btn" onclick="movePlayer(0,1)">‚ñº</button>
    </div>
  </div>

  <!-- Í∞ÄÏö¥Îç∞ Í≥µÍ∞Ñ -->
  <div class="control-spacer"></div>

  <!-- Ïò§Î•∏Ï™Ω: Î©îÎâ¥ Î≤ÑÌäºÎì§ -->
  <div id="menu-container">
    <!-- Menu buttons - ÎßàÏùÑÏö© -->
    <div class="menu-row" id="village-menu">
      <button class="menu-btn" onclick="openMenu('inventory')">üéíÍ∞ÄÎ∞©</button>
      <button class="menu-btn" onclick="openMenu('equip')">‚öîÔ∏èÏû•ÎπÑ</button>
    </div>
    <div class="menu-row" id="village-menu-2">
      <button class="menu-btn" onclick="openMenu('status')">üìäÏÉÅÌÉú</button>
      <button class="menu-btn" onclick="saveGame()">üíæÏ†ÄÏû•</button>
    </div>
    <!-- Menu buttons - ÌïÑÎìúÏö© -->
    <div class="menu-row hidden" id="field-menu">
      <button class="menu-btn" onclick="openMenu('inventory')">üéíÍ∞ÄÎ∞©</button>
      <button class="menu-btn attack" onclick="fieldAttack()">‚öîÔ∏èÍ≥µÍ≤©</button>
    </div>
    <div class="menu-row hidden" id="field-menu-2">
      <button class="menu-btn home" onclick="goToVillage(); saveGame();">üè†ÎßàÏùÑ</button>
      <button class="menu-btn" onclick="saveGame()">üíæÏ†ÄÏû•</button>
    </div>
  </div>
</div>

<!-- Modal Container -->
<div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div id="modal-content"></div>
    <button class="modal-close" onclick="closeModal()">Îã´Í∏∞</button>
  </div>
</div>

<!-- Combat Screen -->
<div id="combat-screen" class="hidden">
  <div id="combat-hud"></div>
  <div id="combat-monster" style="margin-top:10px; text-align:center"></div>
  <canvas id="combat-monster-canvas" width="80" height="80" style="image-rendering:pixelated;margin:6px auto;display:block;"></canvas>
  <div id="combat-monster-info" style="text-align:center;"></div>
  <canvas id="combat-player-canvas" width="80" height="80" style="image-rendering:pixelated;margin:6px auto;display:block;"></canvas>
  <div class="combat-log" id="combat-log"></div>
  <div class="combat-btns" id="combat-btns"></div>
</div>

<!-- Notification -->
<div id="notification" class="hidden"></div>

<script>
// ============== DATABASE ==============
const ITEMS_DB = {
  wood: { name:"ÎÇòÎ¨¥", emoji:"ü™µ", type:"material", desc:"Í±¥Ï∂ï Ïû¨Î£å" },
  stone: { name:"Îèå", emoji:"ü™®", type:"material", desc:"Îã®Îã®Ìïú Ïû¨Î£å" },
  herb: { name:"ÏïΩÏ¥à", emoji:"üåø", type:"material", desc:"Ìè¨ÏÖò Ïû¨Î£å" },
  meat: { name:"Í≥†Í∏∞", emoji:"üçñ", type:"food", heal:20, desc:"Ï≤¥Î†• +20" },
  apple: { name:"ÏÇ¨Í≥º", emoji:"üçé", type:"food", heal:10, desc:"Ï≤¥Î†• +10" },
  slimeGel: { name:"Ïä¨ÎùºÏûÑ Ï†§", emoji:"üíß", type:"material", desc:"Ïä¨ÎùºÏûÑ ÎìúÎ°≠" },
  wolfFang: { name:"ÎäëÎåÄ Ïù¥Îπ®", emoji:"ü¶∑", type:"material", desc:"ÎäëÎåÄ ÎìúÎ°≠" },
  feather: { name:"ÍπÉÌÑ∏", emoji:"ü™∂", type:"material", desc:"ÏÉà ÎìúÎ°≠" },
  leather: { name:"Í∞ÄÏ£Ω", emoji:"üü´", type:"material", desc:"Î∞©Ïñ¥Íµ¨ Ïû¨Î£å" },
  gem: { name:"Î≥¥ÏÑù", emoji:"üíé", type:"material", desc:"Ìù¨Í∑Ä Ïû¨Î£å" },
  potion: { name:"Ìè¨ÏÖò", emoji:"üß™", type:"food", heal:50, desc:"Ï≤¥Î†• +50" },
  superPotion: { name:"Í≥†Í∏â Ìè¨ÏÖò", emoji:"üß¥", type:"food", heal:100, desc:"Ï≤¥Î†• +100" },
  starFragment: { name:"Î≥ÑÏ°∞Í∞Å", emoji:"‚≠ê", type:"material", desc:"ÎπÑÎ∞Ä Ïû¨Î£å" },
  dragonScale: { name:"Ïö©ÎπÑÎäò", emoji:"üê≤", type:"material", desc:"Ï†ÑÏÑ§ Ïû¨Î£å" },
  mysteryBox: { name:"ÎØ∏Ïä§ÌÑ∞Î¶¨ Î∞ïÏä§", emoji:"üéÅ", type:"special", desc:"Î¨¥ÏóáÏù¥ Îì§ÏóàÏùÑÍπå?" },
  goldenApple: { name:"Ìô©Í∏à ÏÇ¨Í≥º", emoji:"üçè", type:"food", heal:80, desc:"Ï≤¥Î†• +80 (Ìù¨Í∑Ä)" },
  woodSword: { name:"ÎÇòÎ¨¥ Í≤Ä", emoji:"üó°Ô∏è", type:"weapon", atk:3, desc:"Í≥µÍ≤©Î†• +3" },
  stoneSword: { name:"Îèå Í≤Ä", emoji:"‚öîÔ∏è", type:"weapon", atk:6, desc:"Í≥µÍ≤©Î†• +6" },
  ironSword: { name:"Í∞ïÏ≤† Í≤Ä", emoji:"üî™", type:"weapon", atk:10, desc:"Í≥µÍ≤©Î†• +10" },
  legendSword: { name:"Ï†ÑÏÑ§Ïùò Í≤Ä", emoji:"‚öîÔ∏è", type:"weapon", atk:15, desc:"Í≥µÍ≤©Î†• +15" },
  // Î∞©Ìå® (shield)
  woodShield: { name:"ÎÇòÎ¨¥ Î∞©Ìå®", emoji:"üõ°Ô∏è", type:"shield", def:2, desc:"Î∞©Ïñ¥Î†• +2" },
  ironShield: { name:"Í∞ïÏ≤† Î∞©Ìå®", emoji:"üõ°Ô∏è", type:"shield", def:5, desc:"Î∞©Ïñ¥Î†• +5" },
  dragonShield: { name:"Ïö©Ïùò Î∞©Ìå®", emoji:"üî∞", type:"shield", def:10, desc:"Î∞©Ïñ¥Î†• +10" },
  // Í∞ëÏò∑ (armor)
  leatherArmor: { name:"Í∞ÄÏ£Ω Í∞ëÏò∑", emoji:"ü¶∫", type:"armor", def:5, desc:"Î∞©Ïñ¥Î†• +5" },
  ironArmor: { name:"Í∞ïÏ≤† Í∞ëÏò∑", emoji:"üéΩ", type:"armor", def:8, desc:"Î∞©Ïñ¥Î†• +8" },
  dragonArmor: { name:"Ïö©Ïùò Í∞ëÏò∑", emoji:"üëï", type:"armor", def:12, desc:"Î∞©Ïñ¥Î†• +12" },
  // Ïã†Î∞ú (shoes)
  leatherShoes: { name:"Í∞ÄÏ£Ω Ïã†Î∞ú", emoji:"üëü", type:"shoes", def:1, spd:1, desc:"Î∞©Ïñ¥Î†• +1" },
  ironBoots: { name:"Í∞ïÏ≤† Î∂ÄÏ∏†", emoji:"ü•æ", type:"shoes", def:3, spd:1, desc:"Î∞©Ïñ¥Î†• +3" },
  dragonBoots: { name:"Ïö©Ïùò Î∂ÄÏ∏†", emoji:"üë¢", type:"shoes", def:5, atk:2, desc:"Î∞©Ïñ¥Î†• +5, Í≥µÍ≤©Î†• +2" },
  // Ïû•Ïã†Íµ¨ (accessory)
  ring: { name:"ÎßàÎ≤ï Î∞òÏßÄ", emoji:"üíç", type:"accessory", atk:2, def:2, desc:"Í≥µ/Î∞© +2" },
  starRing: { name:"Î≥ÑÏùò Î∞òÏßÄ", emoji:"üí´", type:"accessory", atk:5, def:5, desc:"Í≥µ/Î∞© +5" },
  necklace: { name:"Î≥¥Ìò∏Ïùò Î™©Í±∏Ïù¥", emoji:"üìø", type:"accessory", def:4, desc:"Î∞©Ïñ¥Î†• +4" },
};

const RECIPES = [
  // Î¨¥Í∏∞
  { name:"ÎÇòÎ¨¥ Í≤Ä", result:"woodSword", ingredients:{ wood:5 } },
  { name:"Îèå Í≤Ä", result:"stoneSword", ingredients:{ wood:3, stone:5 } },
  { name:"Í∞ïÏ≤† Í≤Ä", result:"ironSword", ingredients:{ stone:10, wolfFang:3, gem:1 } },
  { name:"Ï†ÑÏÑ§Ïùò Í≤Ä", result:"legendSword", ingredients:{ dragonScale:3, gem:5, starFragment:2 } },
  // Î∞©Ìå®
  { name:"ÎÇòÎ¨¥ Î∞©Ìå®", result:"woodShield", ingredients:{ wood:8 } },
  { name:"Í∞ïÏ≤† Î∞©Ìå®", result:"ironShield", ingredients:{ stone:8, slimeGel:5 } },
  { name:"Ïö©Ïùò Î∞©Ìå®", result:"dragonShield", ingredients:{ dragonScale:3, gem:2, stone:10 } },
  // Í∞ëÏò∑
  { name:"Í∞ÄÏ£Ω Í∞ëÏò∑", result:"leatherArmor", ingredients:{ leather:5, slimeGel:3 } },
  { name:"Í∞ïÏ≤† Í∞ëÏò∑", result:"ironArmor", ingredients:{ stone:12, leather:5, wolfFang:2 } },
  { name:"Ïö©Ïùò Í∞ëÏò∑", result:"dragonArmor", ingredients:{ dragonScale:5, leather:5, gem:3 } },
  // Ïã†Î∞ú
  { name:"Í∞ÄÏ£Ω Ïã†Î∞ú", result:"leatherShoes", ingredients:{ leather:3, slimeGel:2 } },
  { name:"Í∞ïÏ≤† Î∂ÄÏ∏†", result:"ironBoots", ingredients:{ stone:6, leather:3, wolfFang:1 } },
  { name:"Ïö©Ïùò Î∂ÄÏ∏†", result:"dragonBoots", ingredients:{ dragonScale:2, leather:4, gem:2 } },
  // ÏÜåÎ™®Ìíà
  { name:"Ìè¨ÏÖò", result:"potion", ingredients:{ herb:3, slimeGel:2 } },
  { name:"Í≥†Í∏â Ìè¨ÏÖò", result:"superPotion", ingredients:{ potion:2, gem:1, starFragment:1 } },
  // Ïû•Ïã†Íµ¨
  { name:"ÎßàÎ≤ï Î∞òÏßÄ", result:"ring", ingredients:{ gem:3, wolfFang:2, feather:5 } },
  { name:"Î≥ÑÏùò Î∞òÏßÄ", result:"starRing", ingredients:{ starFragment:5, gem:3, dragonScale:1 } },
  { name:"Î≥¥Ìò∏Ïùò Î™©Í±∏Ïù¥", result:"necklace", ingredients:{ gem:2, feather:3, slimeGel:4 } },
];

const MONSTERS = {
  slime: { name:"Ïä¨ÎùºÏûÑ", emoji:"üü¢", hp:15, atk:2, exp:10, drops:[{id:"slimeGel",chance:0.7},{id:"herb",chance:0.3}] },
  bird: { name:"Ï∞∏ÏÉà", emoji:"üê¶", hp:10, atk:1, exp:5, drops:[{id:"feather",chance:0.8},{id:"apple",chance:0.2}] },
  rabbit: { name:"ÌÜ†ÎÅº", emoji:"üê∞", hp:8, atk:1, exp:5, drops:[{id:"meat",chance:0.5},{id:"herb",chance:0.4}] },
  wolf: { name:"ÎäëÎåÄ", emoji:"üê∫", hp:30, atk:5, exp:25, drops:[{id:"wolfFang",chance:0.6},{id:"leather",chance:0.5},{id:"meat",chance:0.4}] },
  bear: { name:"Í≥∞", emoji:"üêª", hp:50, atk:8, exp:40, drops:[{id:"leather",chance:0.7},{id:"meat",chance:0.6},{id:"gem",chance:0.1}] },
  dragon: { name:"ÏïÑÍ∏∞ ÎìúÎûòÍ≥§", emoji:"üêâ", hp:80, atk:12, exp:80, drops:[{id:"gem",chance:0.8},{id:"dragonScale",chance:0.3}] },
  // ÎûúÎç§Î∞ïÏä§ Ïã§Ìå® Ïãú Í∞ïÎ†•Ìïú Î™¨Ïä§ÌÑ∞
  guardian: { name:"ÏàòÌò∏Ïûê", emoji:"üëπ", hp:60, atk:10, exp:50, drops:[{id:"gem",chance:0.9},{id:"starFragment",chance:0.5}] },
  // ÎπÑÎ∞Ä Í≥µÍ∞Ñ Î≥¥Ïä§
  shadowWolf: { name:"Í∑∏Î¶ºÏûê ÎäëÎåÄ", emoji:"üê∫", hp:70, atk:9, exp:60, drops:[{id:"starFragment",chance:0.8},{id:"wolfFang",chance:1.0}] },
  crystalSlime: { name:"ÌÅ¨Î¶¨Ïä§ÌÉà Ïä¨ÎùºÏûÑ", emoji:"üí†", hp:50, atk:6, exp:45, drops:[{id:"gem",chance:1.0},{id:"starFragment",chance:0.6}] },
  phoenixBird: { name:"Î∂àÏÇ¨Ï°∞ ÏÉà", emoji:"ü¶Ö", hp:90, atk:11, exp:70, drops:[{id:"starFragment",chance:0.9},{id:"feather",chance:1.0},{id:"dragonScale",chance:0.3}] },
};

const FIELD_ZONES = [
  { name:"Ï¥àÏõê", emoji:"üå≥", bg:"#4a7c59", monsters:["rabbit","bird","slime"], resources:["wood","herb","apple"], minLv:1, secretBoss:"shadowWolf" },
  { name:"Ïà≤ÏÜç", emoji:"üå≤", bg:"#2d5a3f", monsters:["slime","wolf","bird"], resources:["wood","stone","herb"], minLv:3, secretBoss:"crystalSlime" },
  { name:"ÏÇ∞Í∏∏", emoji:"‚õ∞Ô∏è", bg:"#6b705c", monsters:["wolf","bear"], resources:["stone","herb","gem"], minLv:5, secretBoss:"phoenixBird" },
  { name:"Ïö©Ïùò ÎèôÍµ¥", emoji:"üåã", bg:"#5c3a2e", monsters:["bear","dragon"], resources:["gem","stone"], minLv:8, secretBoss:"phoenixBird" },
];

const VILLAGE_MAP = [
  "TTTTTTTTTTTTTTTTTTTT",
  "TG..F......F.....G.T",
  "T..................T",
  "T....H.......S.....T",
  "T..................T",
  "T......P...........T",
  "T..................T",
  "T....C.......W.....T",
  "T..................T",
  "T..F...........F...T",
  "TG...............G.T",
  "TTTTTTTTEDTTTTTTTTTT",
];

const TILE = 38;
const COLS = 20;
const ROWS = 12;

// ÏÉâÏÉÅ ÏòµÏÖò
const HAIR_COLORS = ['#8B4513', '#1a1a1a', '#FFD700', '#FF6B35', '#D2691E', '#4A0E0E', '#2F4F4F'];
const CLOTHES_COLORS = ['#4169E1', '#FF69B4', '#32CD32', '#FF4500', '#9400D3', '#20B2AA', '#FFD700'];
const SHOES_COLORS = ['#8B4513', '#1a1a1a', '#FFF', '#FF0000', '#4169E1', '#2F4F4F'];

// Ïª§Ïä§ÌÖÄ ÏÉâÏÉÅ ÏÑ†ÌÉù
let customColors = {
  hair: '#8B4513',
  clothes: '#4169E1',
  shoes: '#8B4513'
};

// ============== PIXEL ART - ÎèôÏ†Å ÏÉùÏÑ± ==============
function generatePlayerSprite(gender, hairColor, clothesColor, shoesColor) {
  const skinColor = '#FFDAB9';
  if (gender === 'boy') {
    return [
      [0,0,hairColor,hairColor,hairColor,hairColor,0,0],
      [0,hairColor,hairColor,hairColor,hairColor,hairColor,hairColor,0],
      [0,skinColor,skinColor,skinColor,skinColor,skinColor,skinColor,0],
      [0,skinColor,'#000',skinColor,skinColor,'#000',skinColor,0],
      [0,0,skinColor,skinColor,skinColor,skinColor,0,0],
      [0,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,0],
      [0,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,0],
      [0,0,shoesColor,shoesColor,shoesColor,shoesColor,0,0],
    ];
  } else {
    return [
      [0,hairColor,hairColor,hairColor,hairColor,hairColor,hairColor,0],
      [hairColor,hairColor,hairColor,hairColor,hairColor,hairColor,hairColor,hairColor],
      [0,skinColor,skinColor,skinColor,skinColor,skinColor,skinColor,0],
      [0,skinColor,'#000',skinColor,skinColor,'#000',skinColor,0],
      [0,0,skinColor,'#FFC0CB','#FFC0CB',skinColor,0,0],
      [0,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,0],
      [0,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,clothesColor,0],
      [0,0,shoesColor,shoesColor,shoesColor,shoesColor,0,0],
    ];
  }
}

const MONSTER_SPRITES = {
  slime: [
    [0,0,0,'#32CD32','#32CD32',0,0,0],
    [0,0,'#32CD32','#7CFC00','#7CFC00','#32CD32',0,0],
    [0,'#32CD32','#7CFC00','#7CFC00','#7CFC00','#7CFC00','#32CD32',0],
    ['#32CD32','#7CFC00','#000','#7CFC00','#7CFC00','#000','#7CFC00','#32CD32'],
    ['#32CD32','#7CFC00','#7CFC00','#7CFC00','#7CFC00','#7CFC00','#7CFC00','#32CD32'],
    ['#32CD32','#32CD32','#7CFC00','#7CFC00','#7CFC00','#7CFC00','#32CD32','#32CD32'],
    [0,'#32CD32','#32CD32','#32CD32','#32CD32','#32CD32','#32CD32',0],
    [0,0,'#228B22','#228B22','#228B22','#228B22',0,0],
  ],
  bird: [
    [0,0,0,'#8B4513',0,0,0,0],
    [0,0,'#8B4513','#D2691E','#8B4513',0,0,0],
    [0,'#D2691E','#D2691E','#D2691E','#D2691E','#D2691E',0,0],
    ['#FFA500','#D2691E','#000','#D2691E','#D2691E','#D2691E','#D2691E',0],
    [0,'#D2691E','#D2691E','#D2691E','#D2691E','#D2691E','#D2691E','#8B4513'],
    [0,0,'#D2691E','#D2691E','#D2691E','#D2691E',0,0],
    [0,0,0,'#FFA500',0,'#FFA500',0,0],
    [0,0,0,'#FFA500',0,'#FFA500',0,0],
  ],
  rabbit: [
    [0,'#FFF','#FFF',0,0,'#FFF','#FFF',0],
    [0,'#FFF','#FFC0CB',0,0,'#FFC0CB','#FFF',0],
    [0,0,'#FFF','#FFF','#FFF','#FFF',0,0],
    [0,'#FFF','#000','#FFF','#FFF','#000','#FFF',0],
    [0,'#FFF','#FFF','#FFC0CB','#FFC0CB','#FFF','#FFF',0],
    [0,0,'#FFF','#FFF','#FFF','#FFF',0,0],
    [0,0,'#FFF',0,0,'#FFF',0,0],
    [0,0,'#FFC0CB',0,0,'#FFC0CB',0,0],
  ],
  wolf: [
    ['#696969','#696969',0,0,0,0,'#696969','#696969'],
    ['#808080','#A9A9A9','#808080',0,0,'#808080','#A9A9A9','#808080'],
    [0,'#808080','#A9A9A9','#A9A9A9','#A9A9A9','#A9A9A9','#808080',0],
    [0,'#808080','#000','#A9A9A9','#A9A9A9','#000','#808080',0],
    [0,0,'#A9A9A9','#A9A9A9','#A9A9A9','#A9A9A9',0,0],
    [0,'#808080','#808080','#A9A9A9','#A9A9A9','#808080','#808080',0],
    ['#808080','#808080',0,'#808080','#808080',0,'#808080','#808080'],
    ['#696969',0,0,'#696969','#696969',0,0,'#696969'],
  ],
  bear: [
    ['#8B4513',0,0,0,0,0,0,'#8B4513'],
    ['#A0522D','#8B4513',0,0,0,0,'#8B4513','#A0522D'],
    [0,'#A0522D','#8B4513','#8B4513','#8B4513','#8B4513','#A0522D',0],
    [0,'#8B4513','#000','#8B4513','#8B4513','#000','#8B4513',0],
    [0,0,'#8B4513','#8B4513','#8B4513','#8B4513',0,0],
    [0,'#A0522D','#A0522D','#8B4513','#8B4513','#A0522D','#A0522D',0],
    [0,'#8B4513','#8B4513','#8B4513','#8B4513','#8B4513','#8B4513',0],
    [0,'#8B4513',0,0,0,0,'#8B4513',0],
  ],
  dragon: [
    [0,'#9400D3',0,0,0,0,'#9400D3',0],
    ['#9400D3','#8A2BE2','#9400D3',0,0,'#9400D3','#8A2BE2','#9400D3'],
    [0,'#8A2BE2','#8A2BE2','#8A2BE2','#8A2BE2','#8A2BE2','#8A2BE2',0],
    [0,'#8A2BE2','#FF0','#8A2BE2','#8A2BE2','#FF0','#8A2BE2',0],
    ['#FF4500',0,'#8A2BE2','#8A2BE2','#8A2BE2','#8A2BE2',0,'#FF4500'],
    [0,0,'#8A2BE2','#8A2BE2','#8A2BE2','#8A2BE2',0,0],
    [0,'#8A2BE2',0,'#8A2BE2','#8A2BE2',0,'#8A2BE2',0],
    [0,'#9400D3',0,0,0,0,'#9400D3',0],
  ],
  guardian: [
    [0,'#8B0000','#8B0000',0,0,'#8B0000','#8B0000',0],
    ['#8B0000','#FF4500','#FF4500','#8B0000','#8B0000','#FF4500','#FF4500','#8B0000'],
    [0,'#FF4500','#FF0','#FF4500','#FF4500','#FF0','#FF4500',0],
    [0,'#FF4500','#FF4500','#FF4500','#FF4500','#FF4500','#FF4500',0],
    [0,0,'#8B0000','#FF4500','#FF4500','#8B0000',0,0],
    [0,'#8B0000','#8B0000','#8B0000','#8B0000','#8B0000','#8B0000',0],
    ['#8B0000','#8B0000',0,'#8B0000','#8B0000',0,'#8B0000','#8B0000'],
    [0,'#8B0000',0,0,0,0,'#8B0000',0],
  ],
  shadowWolf: [
    ['#2F2F2F','#2F2F2F',0,0,0,0,'#2F2F2F','#2F2F2F'],
    ['#1a1a1a','#4B0082','#1a1a1a',0,0,'#1a1a1a','#4B0082','#1a1a1a'],
    [0,'#1a1a1a','#4B0082','#4B0082','#4B0082','#4B0082','#1a1a1a',0],
    [0,'#1a1a1a','#FF0','#4B0082','#4B0082','#FF0','#1a1a1a',0],
    [0,0,'#4B0082','#4B0082','#4B0082','#4B0082',0,0],
    [0,'#1a1a1a','#1a1a1a','#4B0082','#4B0082','#1a1a1a','#1a1a1a',0],
    ['#1a1a1a','#1a1a1a',0,'#1a1a1a','#1a1a1a',0,'#1a1a1a','#1a1a1a'],
    ['#2F2F2F',0,0,'#2F2F2F','#2F2F2F',0,0,'#2F2F2F'],
  ],
  crystalSlime: [
    [0,0,0,'#00CED1','#00CED1',0,0,0],
    [0,0,'#00CED1','#E0FFFF','#E0FFFF','#00CED1',0,0],
    [0,'#00CED1','#E0FFFF','#FFF','#FFF','#E0FFFF','#00CED1',0],
    ['#00CED1','#E0FFFF','#4169E1','#FFF','#FFF','#4169E1','#E0FFFF','#00CED1'],
    ['#00CED1','#E0FFFF','#E0FFFF','#E0FFFF','#E0FFFF','#E0FFFF','#E0FFFF','#00CED1'],
    ['#00CED1','#00CED1','#E0FFFF','#E0FFFF','#E0FFFF','#E0FFFF','#00CED1','#00CED1'],
    [0,'#00CED1','#00CED1','#00CED1','#00CED1','#00CED1','#00CED1',0],
    [0,0,'#008B8B','#008B8B','#008B8B','#008B8B',0,0],
  ],
  phoenixBird: [
    [0,'#FF4500','#FF4500',0,0,'#FF4500','#FF4500',0],
    [0,'#FF4500','#FFD700','#FF4500','#FF4500','#FFD700','#FF4500',0],
    ['#FF4500','#FFD700','#FFD700','#FFD700','#FFD700','#FFD700','#FFD700','#FF4500'],
    ['#FF0','#FFD700','#000','#FFD700','#FFD700','#000','#FFD700','#FF0'],
    [0,'#FFD700','#FFD700','#FFD700','#FFD700','#FFD700','#FFD700',0],
    ['#FF4500','#FF4500','#FFD700','#FFD700','#FFD700','#FFD700','#FF4500','#FF4500'],
    [0,0,'#FF4500',0,0,'#FF4500',0,0],
    [0,0,'#FF4500',0,0,'#FF4500',0,0],
  ],
};

const WEAPON_SPRITES = {
  woodSword: [
    [0,0,0,0,'#8B4513','#8B4513'],
    [0,0,0,'#8B4513','#D2B48C',0],
    [0,0,'#8B4513','#D2B48C',0,0],
    [0,'#8B4513','#D2B48C',0,0,0],
    ['#654321','#D2B48C',0,0,0,0],
    ['#654321',0,0,0,0,0],
  ],
  stoneSword: [
    [0,0,0,0,'#696969','#A9A9A9'],
    [0,0,0,'#696969','#C0C0C0',0],
    [0,0,'#696969','#C0C0C0',0,0],
    [0,'#696969','#C0C0C0',0,0,0],
    ['#8B4513','#A9A9A9',0,0,0,0],
    ['#654321',0,0,0,0,0],
  ],
  ironSword: [
    [0,0,0,0,'#4682B4','#87CEEB'],
    [0,0,0,'#4682B4','#ADD8E6',0],
    [0,0,'#4682B4','#ADD8E6',0,0],
    [0,'#4682B4','#ADD8E6',0,0,0],
    ['#FFD700','#B8860B',0,0,0,0],
    ['#8B4513',0,0,0,0,0],
  ],
  legendSword: [
    [0,0,0,0,'#9400D3','#FFD700'],
    [0,0,0,'#9400D3','#FFD700',0],
    [0,0,'#9400D3','#FFD700',0,0],
    [0,'#9400D3','#FFD700',0,0,0],
    ['#FFD700','#FF4500',0,0,0,0],
    ['#8B4513',0,0,0,0,0],
  ],
};

function getMonsterSprite(monsterId) {
  return MONSTER_SPRITES[monsterId];
}

// ============== GAME STATE ==============
let gameState = {
  screen: "title", gender: null, playerName: "",
  customColors: { hair: '#8B4513', clothes: '#4169E1', shoes: '#8B4513' },
  player: null, inventory: {}, equipped: { weapon:null, shield:null, armor:null, shoes:null, accessory:null },
  gold: 50, vilPos: {x:10,y:5}, fieldPos: {x:10,y:6},
  currentZone: 0, fieldItems: [], fieldMonsters: [],
  randomBoxes: [], secretPortals: [],
  combat: null, combatLog: [],
  attacking: false, attackDir: {x:1, y:0}, attackFrame: 0, lastAttackTime: 0,
};

// ============== SAVE/LOAD SYSTEM ==============
const SAVE_KEY = "myworld_saves_v2";

function getSavedGames() {
  try { return JSON.parse(localStorage.getItem(SAVE_KEY)) || []; }
  catch { return []; }
}

function saveGame() {
  const saves = getSavedGames();
  const saveData = {
    id: gameState.saveId || Date.now(),
    name: gameState.playerName,
    gender: gameState.gender,
    customColors: gameState.customColors,
    player: gameState.player,
    inventory: gameState.inventory,
    equipped: gameState.equipped,
    gold: gameState.gold,
    vilPos: gameState.vilPos,
    currentZone: gameState.currentZone,
    savedAt: new Date().toISOString(),
  };
  const idx = saves.findIndex(s => s.id === saveData.id);
  if (idx >= 0) saves[idx] = saveData;
  else saves.push(saveData);
  localStorage.setItem(SAVE_KEY, JSON.stringify(saves));
  gameState.saveId = saveData.id;
  notify("üíæ Ï†ÄÏû• ÏôÑÎ£å!");
}

function loadGame(saveData) {
  gameState.saveId = saveData.id;
  gameState.playerName = saveData.name;
  gameState.gender = saveData.gender;
  gameState.customColors = saveData.customColors || { hair: '#8B4513', clothes: '#4169E1', shoes: '#8B4513' };
  customColors = {...gameState.customColors};
  gameState.player = saveData.player;
  gameState.inventory = saveData.inventory || {};
  gameState.equipped = saveData.equipped || { weapon:null, shield:null, armor:null, shoes:null, accessory:null };
  // Ïù¥Ï†Ñ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞ Ìò∏ÌôòÏÑ±
  if (!gameState.equipped.shield) gameState.equipped.shield = null;
  if (!gameState.equipped.shoes) gameState.equipped.shoes = null;
  gameState.gold = saveData.gold;
  gameState.vilPos = saveData.vilPos || {x:10, y:5};
  gameState.currentZone = saveData.currentZone || 0;
  showScreen("village");
  notify(`üéÆ ${saveData.name} Î∂àÎü¨Ïò§Í∏∞!`);
}

function deleteSave(id) {
  if (!confirm("Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;
  let saves = getSavedGames().filter(s => s.id !== id);
  localStorage.setItem(SAVE_KEY, JSON.stringify(saves));
  renderSavedChars();
}

function renderSavedChars() {
  const container = document.getElementById("saved-chars");
  const saves = getSavedGames();
  if (!saves.length) {
    container.innerHTML = '<p style="color:#666; font-size:12px">Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>';
    return;
  }
  container.innerHTML = '<p style="color:#fff; font-size:13px; margin-bottom:8px">üìÇ Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞</p><div class="saved-chars-container">' +
    saves.map(s => `
      <div class="saved-char-card" onclick='loadGame(${JSON.stringify(s).replace(/'/g, "&#39;")})'>
        <button class="delete-char-btn" onclick="event.stopPropagation();deleteSave(${s.id})">√ó</button>
        <canvas class="saved-char-preview" data-gender="${s.gender}" data-colors='${JSON.stringify(s.customColors||{})}' width="40" height="40" style="image-rendering:pixelated;"></canvas>
        <div class="char-name">${s.name}</div>
        <div class="char-info">Lv.${s.player.level} üí∞${s.gold}G</div>
      </div>
    `).join('') + '</div>';
  setTimeout(() => {
    document.querySelectorAll('.saved-char-preview').forEach(canvas => {
      const ctx2 = canvas.getContext('2d');
      const colors = JSON.parse(canvas.dataset.colors || '{}');
      const sprite = generatePlayerSprite(
        canvas.dataset.gender,
        colors.hair || '#8B4513',
        colors.clothes || '#4169E1',
        colors.shoes || '#8B4513'
      );
      drawPixelSpriteOnCanvas(ctx2, sprite, 0, 0, 5);
    });
  }, 0);
}

function createNewChar(gender) {
  const name = document.getElementById("char-name-input").value.trim();
  if (!name) { notify("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!"); return; }

  gameState.saveId = Date.now();
  gameState.playerName = name;
  gameState.gender = gender;
  gameState.customColors = {...customColors};
  gameState.player = { level:1, hp:100, maxHp:100, atk:5, def:2, exp:0, nextExp:expForLevel(1) };
  gameState.inventory = { wood:3, apple:2 };
  gameState.equipped = { weapon:null, shield:null, armor:null, shoes:null, accessory:null };
  gameState.gold = 50;
  gameState.vilPos = { x:10, y:5 };
  saveGame();
  showScreen("village");
}

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = COLS * TILE;
  canvas.height = ROWS * TILE;
}
resizeCanvas();

// ============== UTILITIES ==============
function expForLevel(lv) { return lv * 30 + (lv - 1) * 15; }

function getStats() {
  if (!gameState.player) return { atk:0, def:0 };
  let atk = gameState.player.atk, def = gameState.player.def;
  Object.values(gameState.equipped).forEach(id => {
    if (id && ITEMS_DB[id]) {
      if (ITEMS_DB[id].atk) atk += ITEMS_DB[id].atk;
      if (ITEMS_DB[id].def) def += ITEMS_DB[id].def;
    }
  });
  return { atk, def };
}

function addItem(id, count=1) { gameState.inventory[id] = (gameState.inventory[id]||0) + count; }
function removeItem(id, count=1) {
  gameState.inventory[id] = (gameState.inventory[id]||0) - count;
  if (gameState.inventory[id] <= 0) delete gameState.inventory[id];
}

let notifTimer = null;
function notify(msg) {
  const el = document.getElementById("notification");
  el.textContent = msg; el.classList.remove("hidden"); el.style.opacity = 1;
  clearTimeout(notifTimer);
  notifTimer = setTimeout(() => { el.style.opacity = 0; setTimeout(() => el.classList.add("hidden"), 300); }, 2000);
}

function gainExp(amount) {
  let p = gameState.player;
  p.exp += amount;
  while (p.exp >= p.nextExp) {
    p.exp -= p.nextExp;
    p.level++; p.maxHp += 15; p.hp = p.maxHp; p.atk += 2; p.def += 1;
    p.nextExp = expForLevel(p.level);
    notify(`üéâ Î†àÎ≤® ÏóÖ! Lv.${p.level}!`);
  }
}

// ============== UI UPDATES ==============
function updateHUD() {
  const p = gameState.player; if (!p) return;
  const s = getStats();
  document.getElementById("hud-name").textContent = gameState.playerName || "";
  document.getElementById("hud-level").textContent = `Lv.${p.level}`;
  document.getElementById("hud-hp").textContent = `${p.hp}/${p.maxHp}`;
  document.getElementById("hud-hp-bar").style.width = `${(p.hp/p.maxHp)*100}%`;
  document.getElementById("hud-hp-bar").style.background = p.hp/p.maxHp > 0.5 ? "#4CAF50" : p.hp/p.maxHp > 0.25 ? "#FF9800" : "#f44336";
  document.getElementById("hud-exp-bar").style.width = `${(p.exp/p.nextExp)*100}%`;
  document.getElementById("hud-gold").textContent = `üí∞${gameState.gold}`;
  document.getElementById("hud-stats").textContent = `‚öî${s.atk} üõ°${s.def}`;
}

function showScreen(name) {
  gameState.screen = name;
  document.getElementById("title-screen").classList.toggle("hidden", name !== "title");
  document.getElementById("game-container").classList.toggle("hidden", name === "title" || name === "combat");
  document.getElementById("hud").classList.toggle("hidden", name === "title");
  document.getElementById("controls").classList.toggle("hidden", name === "title" || name === "combat");
  document.getElementById("village-menu").classList.toggle("hidden", name !== "village");
  document.getElementById("village-menu-2").classList.toggle("hidden", name !== "village");
  document.getElementById("field-menu").classList.toggle("hidden", name !== "field");
  document.getElementById("field-menu-2").classList.toggle("hidden", name !== "field");
  document.getElementById("combat-screen").classList.toggle("hidden", name !== "combat");
  document.getElementById("zone-info").classList.toggle("hidden", name !== "field");

  if (name === "field") {
    const z = FIELD_ZONES[gameState.currentZone];
    document.getElementById("zone-info").textContent = `${z.emoji} ${z.name}`;
  }
  updateHUD();
  render();
}

// ============== RENDERING ==============
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (gameState.screen === "village") renderVillage();
  else if (gameState.screen === "field") renderField();
}

function drawEmoji(emoji, x, y, size=20) {
  ctx.font = `${size}px serif`;
  ctx.textAlign = "center"; ctx.textBaseline = "middle";
  ctx.fillText(emoji, x + TILE/2, y + TILE/2);
}

function drawPixelSprite(spriteData, x, y, scale = 4.5) {
  if (!spriteData) return;
  const offsetX = x + (TILE - 8 * scale) / 2;
  const offsetY = y + (TILE - 8 * scale) / 2;
  for (let row = 0; row < spriteData.length; row++) {
    for (let col = 0; col < spriteData[row].length; col++) {
      const color = spriteData[row][col];
      if (color && color !== 0) {
        ctx.fillStyle = color;
        ctx.fillRect(offsetX + col * scale, offsetY + row * scale, scale, scale);
      }
    }
  }
}

function drawPixelSpriteOnCanvas(context, spriteData, x, y, scale = 10) {
  if (!spriteData) return;
  for (let row = 0; row < spriteData.length; row++) {
    for (let col = 0; col < spriteData[row].length; col++) {
      const color = spriteData[row][col];
      if (color && color !== 0) {
        context.fillStyle = color;
        context.fillRect(x + col * scale, y + row * scale, scale, scale);
      }
    }
  }
}

function getPlayerSprite() {
  return generatePlayerSprite(
    gameState.gender,
    gameState.customColors.hair,
    gameState.customColors.clothes,
    gameState.customColors.shoes
  );
}

function renderVillage() {
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      const tile = VILLAGE_MAP[y]?.[x] || ".";
      const px = x * TILE, py = y * TILE;
      ctx.fillStyle = tile === "T" ? "#3a5a2a" : "#5a8a4a";
      ctx.fillRect(px, py, TILE, TILE);
      ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.strokeRect(px, py, TILE, TILE);
      const emojiMap = { H:"üè†", S:"üè™", C:"üî®", W:"‚õ≤", F:"üåæ", G:"üå∏", E:"üö™", D:"üö™", T:"üå≥" };
      if (emojiMap[tile]) drawEmoji(emojiMap[tile], px, py, tile === "T" ? 12 : 18);
    }
  }
  const pp = gameState.vilPos;
  drawPlayerWithWeapon(pp.x * TILE, pp.y * TILE);
}

function renderField() {
  const zone = FIELD_ZONES[gameState.currentZone];
  const time = Date.now();

  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      const px = x * TILE, py = y * TILE;
      const isBorder = y===0||y===ROWS-1||x===0||x===COLS-1;
      ctx.fillStyle = isBorder ? darken(zone.bg, 0.4) : zone.bg;
      ctx.fillRect(px, py, TILE, TILE);
      ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.strokeRect(px, py, TILE, TILE);

      // Í∞ÄÏû•ÏûêÎ¶¨Îäî Î≤ΩÏúºÎ°ú ÌëúÏãú (Ïù¥Îèô Î∂àÍ∞Ä)
      if (isBorder) {
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.fillRect(px, py, TILE, TILE);
      } else if (Math.sin(x*7+y*13) > 0.7) {
        drawEmoji(["üå±","üçÄ","üåø"][(x+y)%3], px, py, 10);
      }
    }
  }

  // ÎπÑÎ∞Ä Ìè¨ÌÉà (Î∞òÏßùÏûÑ) - Îçî ÎààÏóê ÎùÑÍ≤å
  gameState.secretPortals.forEach(p => {
    const alpha = 0.5 + Math.sin(time/150) * 0.5;
    const px = p.x * TILE, py = p.y * TILE;

    // Ïô∏Î∂Ä Í∏ÄÎ°úÏö∞ Ìö®Í≥º
    ctx.fillStyle = `rgba(148, 0, 211, ${alpha * 0.4})`;
    ctx.fillRect(px - 2, py - 2, TILE + 4, TILE + 4);

    // ÎÇ¥Î∂Ä Î∞òÏßùÏù¥Îäî Î∞∞Í≤Ω
    ctx.fillStyle = `rgba(255, 215, 0, ${alpha})`;
    ctx.fillRect(px + 2, py + 2, TILE - 4, TILE - 4);

    // Ï§ëÏïô ÎπõÎÇòÎäî Ïõê
    ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
    ctx.beginPath();
    ctx.arc(px + TILE/2, py + TILE/2, 10 + Math.sin(time/100) * 3, 0, Math.PI * 2);
    ctx.fill();

    // Î∞òÏßùÏù¥Îäî Î≥Ñ Ïù¥Î™®ÏßÄ
    const starSize = 20 + Math.sin(time/200) * 4;
    drawEmoji("üåü", px, py, starSize);
  });

  // ÎûúÎç§Î∞ïÏä§
  gameState.randomBoxes.forEach(b => {
    const bounce = Math.sin(time/300) * 2;
    drawEmoji("üéÅ", b.x * TILE, b.y * TILE + bounce, 20);
  });

  // ÏïÑÏù¥ÌÖú
  gameState.fieldItems.forEach(item => drawEmoji(ITEMS_DB[item.id].emoji, item.x*TILE, item.y*TILE, 16));

  // Î™¨Ïä§ÌÑ∞
  gameState.fieldMonsters.forEach(m => {
    const sprite = getMonsterSprite(m.id);
    if (sprite) drawPixelSprite(sprite, m.x*TILE, m.y*TILE, 4.5);
    else drawEmoji(m.emoji, m.x*TILE, m.y*TILE, 18);
    const hpX = m.x*TILE+3, hpY = m.y*TILE+TILE-5;
    ctx.fillStyle = "#333"; ctx.fillRect(hpX, hpY, TILE-6, 3);
    ctx.fillStyle = "#f44"; ctx.fillRect(hpX, hpY, (TILE-6)*(m.currentHp/m.hp), 3);
  });

  // ÌîåÎ†àÏù¥Ïñ¥
  const fp = gameState.fieldPos;
  drawPlayerWithWeapon(fp.x*TILE, fp.y*TILE);

  if (gameState.attacking) drawAttackEffect(fp.x*TILE, fp.y*TILE);
}

function drawPlayerWithWeapon(x, y) {
  const playerSprite = getPlayerSprite();
  const scale = 4.5;
  const offsetX = x + (TILE - 8 * scale) / 2;
  const offsetY = y + (TILE - 8 * scale) / 2;

  let attackOffsetX = 0, attackOffsetY = 0;
  if (gameState.attacking && gameState.attackFrame < 6) {
    const frame = gameState.attackFrame;
    attackOffsetX = gameState.attackDir.x * (frame < 3 ? frame * 2 : (6 - frame) * 2);
    attackOffsetY = gameState.attackDir.y * (frame < 3 ? frame * 2 : (6 - frame) * 2);
  }

  for (let row = 0; row < playerSprite.length; row++) {
    for (let col = 0; col < playerSprite[row].length; col++) {
      const color = playerSprite[row][col];
      if (color && color !== 0) {
        ctx.fillStyle = color;
        ctx.fillRect(offsetX + col * scale + attackOffsetX, offsetY + row * scale + attackOffsetY, scale, scale);
      }
    }
  }

  const weaponId = gameState.equipped.weapon;
  if (weaponId && WEAPON_SPRITES[weaponId]) {
    const wSprite = WEAPON_SPRITES[weaponId];
    const wScale = 3;
    let wx = offsetX + 8 * scale - 2 + attackOffsetX;
    let wy = offsetY + 2 * scale + attackOffsetY;
    if (gameState.attacking && gameState.attackFrame < 6) {
      wx += gameState.attackDir.x * 8;
      wy += gameState.attackDir.y * 8;
    }
    for (let row = 0; row < wSprite.length; row++) {
      for (let col = 0; col < wSprite[row].length; col++) {
        const color = wSprite[row][col];
        if (color && color !== 0) {
          ctx.fillStyle = color;
          ctx.fillRect(wx + col * wScale, wy + row * wScale, wScale, wScale);
        }
      }
    }
  }
}

function drawAttackEffect(x, y) {
  const dir = gameState.attackDir;
  const effectX = x + TILE/2 + dir.x * TILE;
  const effectY = y + TILE/2 + dir.y * TILE;

  ctx.save();
  ctx.globalAlpha = 1 - gameState.attackFrame / 8;
  ctx.fillStyle = "#FFD700";
  ctx.beginPath();
  ctx.arc(effectX, effectY, 8 + gameState.attackFrame * 1.5, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = "#FFF";
  ctx.lineWidth = 2;
  ctx.beginPath();
  const angle = Math.atan2(dir.y, dir.x);
  ctx.moveTo(effectX - Math.cos(angle + 0.5) * 12, effectY - Math.sin(angle + 0.5) * 12);
  ctx.lineTo(effectX + Math.cos(angle - 0.5) * 12, effectY + Math.sin(angle - 0.5) * 12);
  ctx.stroke();
  ctx.restore();
}

function darken(hex, amount) {
  let r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgb(${Math.floor(r*(1-amount))},${Math.floor(g*(1-amount))},${Math.floor(b*(1-amount))})`;
}

// ============== MOVEMENT ==============
function movePlayer(dx, dy) {
  if (gameState.screen === "village") moveVillage(dx, dy);
  else if (gameState.screen === "field") moveField(dx, dy);
}

function moveVillage(dx, dy) {
  gameState.attackDir = {x: dx, y: dy};
  const nx = gameState.vilPos.x + dx, ny = gameState.vilPos.y + dy;
  if (nx < 0 || nx >= COLS || ny < 0 || ny >= ROWS) return;
  const tile = VILLAGE_MAP[ny]?.[nx];
  if (tile === "T") return;
  if (tile === "E" || tile === "D") { openMenu("field_select"); return; }
  if (tile === "H") { openMenu("home"); return; }
  if (tile === "S") { openMenu("shop"); return; }
  if (tile === "C") { openMenu("craft"); return; }
  if (tile === "W") { gameState.player.hp = gameState.player.maxHp; updateHUD(); notify("‚õ≤ Ï≤¥Î†• ÌöåÎ≥µ!"); return; }
  gameState.vilPos = { x:nx, y:ny };
  render(); updateHUD();
}

function moveField(dx, dy) {
  gameState.attackDir = {x: dx, y: dy};
  const nx = gameState.fieldPos.x + dx, ny = gameState.fieldPos.y + dy;

  // Î≤Ω(Í∞ÄÏû•ÏûêÎ¶¨)ÏúºÎ°úÎäî Ïù¥Îèô Î∂àÍ∞Ä
  if (nx <= 0 || nx >= COLS-1 || ny <= 0 || ny >= ROWS-1) return;

  // ÎûúÎç§Î∞ïÏä§ Ï≤¥ÌÅ¨
  const boxIdx = gameState.randomBoxes.findIndex(b => b.x === nx && b.y === ny);
  if (boxIdx >= 0) {
    openRandomBoxQuiz(boxIdx);
    return;
  }

  // ÎπÑÎ∞Ä Ìè¨ÌÉà Ï≤¥ÌÅ¨
  const portalIdx = gameState.secretPortals.findIndex(p => p.x === nx && p.y === ny);
  if (portalIdx >= 0) {
    enterSecretPortal(portalIdx);
    return;
  }

  // ÏïÑÏù¥ÌÖú Ï§çÍ∏∞
  const itemIdx = gameState.fieldItems.findIndex(i => i.x === nx && i.y === ny);
  if (itemIdx >= 0) {
    const item = gameState.fieldItems[itemIdx];
    addItem(item.id); notify(`${ITEMS_DB[item.id].emoji} ${ITEMS_DB[item.id].name} ÌöçÎìù!`);
    gameState.fieldItems.splice(itemIdx, 1);
  }

  // Î™¨Ïä§ÌÑ∞ Í≥µÍ≤©
  const monIdx = gameState.fieldMonsters.findIndex(m => m.x === nx && m.y === ny);
  if (monIdx >= 0) {
    fieldAttack();
    return;
  }

  gameState.fieldPos = { x:nx, y:ny };
  render(); updateHUD();
}

function goToVillage() {
  showScreen("village");
  notify("ÎßàÏùÑÎ°ú ÎèåÏïÑÏôîÏäµÎãàÎã§!");
}

// ============== FIELD GENERATION ==============
function goToField(zoneIdx) {
  if (gameState.player.level < FIELD_ZONES[zoneIdx].minLv) {
    notify(`Î†àÎ≤® ${FIELD_ZONES[zoneIdx].minLv} Ïù¥ÏÉÅ ÌïÑÏöî!`); return;
  }
  gameState.currentZone = zoneIdx;
  generateField(zoneIdx);
  closeModal();
  showScreen("field");
}

function generateField(zoneIdx) {
  const zone = FIELD_ZONES[zoneIdx];
  gameState.fieldItems = [];
  gameState.fieldMonsters = [];
  gameState.randomBoxes = [];
  gameState.secretPortals = [];

  const startX = Math.floor(COLS/2), startY = Math.floor(ROWS/2);
  const occupied = new Set([`${startX},${startY}`]);

  function getEmptyPos() {
    let x, y, attempts = 0;
    do {
      x = 2 + Math.floor(Math.random()*(COLS-4));
      y = 2 + Math.floor(Math.random()*(ROWS-4));
      attempts++;
    } while (occupied.has(`${x},${y}`) && attempts < 100);
    occupied.add(`${x},${y}`);
    return {x, y};
  }

  // ÏïÑÏù¥ÌÖú 8Í∞ú
  for (let i = 0; i < 8; i++) {
    const res = zone.resources[Math.floor(Math.random()*zone.resources.length)];
    const pos = getEmptyPos();
    gameState.fieldItems.push({ id:res, ...pos });
  }

  // Î™¨Ïä§ÌÑ∞ 5Í∞ú
  for (let i = 0; i < 5; i++) {
    const mId = zone.monsters[Math.floor(Math.random()*zone.monsters.length)];
    const pos = getEmptyPos();
    const m = MONSTERS[mId];
    gameState.fieldMonsters.push({ ...m, id:mId, ...pos, currentHp:m.hp, key:`${mId}_${i}` });
  }

  // ÎûúÎç§Î∞ïÏä§ 1~2Í∞ú
  const boxCount = 1 + Math.floor(Math.random() * 2);
  for (let i = 0; i < boxCount; i++) {
    gameState.randomBoxes.push(getEmptyPos());
  }

  // ÎπÑÎ∞Ä Ìè¨ÌÉà 0~1Í∞ú (60% ÌôïÎ•†Î°ú Ï¶ùÍ∞Ä)
  if (Math.random() < 0.6) {
    gameState.secretPortals.push(getEmptyPos());
  }

  gameState.fieldPos = { x:startX, y:startY };
}

// ============== RANDOM BOX (Íµ¨Íµ¨Îã® ÌÄ¥Ï¶à) ==============
let currentQuiz = null;

function openRandomBoxQuiz(boxIdx) {
  currentQuiz = { boxIdx };
  const a = 2 + Math.floor(Math.random() * 8); // 2~9
  const b = 1 + Math.floor(Math.random() * 9); // 1~9
  currentQuiz.answer = a * b;

  const content = document.getElementById("modal-content");
  content.innerHTML = `
    <h3 style="text-align:center">üéÅ ÎØ∏Ïä§ÌÑ∞Î¶¨ Î∞ïÏä§!</h3>
    <p style="text-align:center; color:#aaa; font-size:13px">Íµ¨Íµ¨Îã® Î¨∏Ï†úÎ•º ÎßûÏ∂îÎ©¥ Î≥¥ÏÉÅ!</p>
    <div class="quiz-question">${a} √ó ${b} = ?</div>
    <input type="number" id="quiz-answer" class="quiz-input" placeholder="?" autofocus>
    <div style="text-align:center">
      <button class="quiz-btn" onclick="submitQuizAnswer()">Ï†ïÎãµ ÌôïÏù∏!</button>
    </div>
  `;
  document.getElementById("modal-overlay").classList.remove("hidden");
  setTimeout(() => document.getElementById("quiz-answer")?.focus(), 100);
}

function submitQuizAnswer() {
  const input = document.getElementById("quiz-answer");
  const userAnswer = parseInt(input.value);

  if (userAnswer === currentQuiz.answer) {
    // Ï†ïÎãµ! Î≥¥ÏÉÅ ÏßÄÍ∏â
    closeModal();
    gameState.randomBoxes.splice(currentQuiz.boxIdx, 1);

    const rewards = ['gem', 'potion', 'goldenApple', 'starFragment', 'superPotion'];
    const reward = rewards[Math.floor(Math.random() * rewards.length)];
    addItem(reward);
    const goldReward = 20 + Math.floor(Math.random() * 30);
    gameState.gold += goldReward;

    notify(`üéâ Ï†ïÎãµ! ${ITEMS_DB[reward].emoji}${ITEMS_DB[reward].name} + ${goldReward}G ÌöçÎìù!`);
    updateHUD();
  } else {
    // Ïò§Îãµ! ÏàòÌò∏Ïûê Î™¨Ïä§ÌÑ∞ Îì±Ïû•
    closeModal();
    gameState.randomBoxes.splice(currentQuiz.boxIdx, 1);

    const guardian = { ...MONSTERS.guardian, id:'guardian', currentHp:MONSTERS.guardian.hp, key:`guardian_${Date.now()}` };
    notify(`üíÄ Ïò§Îãµ! ÏàòÌò∏ÏûêÍ∞Ä ÎÇòÌÉÄÎÇ¨Îã§!`);

    setTimeout(() => startCombat(guardian), 500);
  }
  currentQuiz = null;
}

// ============== SECRET PORTAL ==============
function enterSecretPortal(portalIdx) {
  gameState.secretPortals.splice(portalIdx, 1);

  const zone = FIELD_ZONES[gameState.currentZone];
  const bossId = zone.secretBoss;
  const boss = MONSTERS[bossId];

  const secretBoss = {
    ...boss,
    id: bossId,
    hp: Math.floor(boss.hp * 1.5),
    atk: boss.atk + 2,
    currentHp: Math.floor(boss.hp * 1.5),
    key: `secret_${Date.now()}`,
    isSecretBoss: true
  };

  notify(`‚ú® ÎπÑÎ∞Ä Í≥µÍ∞Ñ Î∞úÍ≤¨! ${boss.name}(Ïù¥)Í∞Ä ÎÇòÌÉÄÎÇ¨Îã§!`);
  setTimeout(() => startCombat(secretBoss), 500);
}

// ============== FIELD ATTACK ==============
function fieldAttack() {
  if (gameState.screen !== "field" || gameState.attacking) return;
  const now = Date.now();
  if (now - gameState.lastAttackTime < 250) return;

  gameState.lastAttackTime = now;
  gameState.attacking = true;
  gameState.attackFrame = 0;

  const fp = gameState.fieldPos;
  const targetX = fp.x + gameState.attackDir.x;
  const targetY = fp.y + gameState.attackDir.y;

  const monIdx = gameState.fieldMonsters.findIndex(m => m.x === targetX && m.y === targetY);

  if (monIdx >= 0) {
    const m = gameState.fieldMonsters[monIdx];
    const s = getStats();
    const dmg = Math.max(1, s.atk - Math.floor(Math.random()*2));
    m.currentHp -= dmg;
    showDamageNumber(targetX * TILE + TILE/2, targetY * TILE, dmg);

    if (m.currentHp <= 0) {
      notify(`üéâ ${m.name} Ï≤òÏπò! +${m.exp} EXP`);
      const drops = [];
      m.drops.forEach(d => { if (Math.random() < d.chance) { addItem(d.id); drops.push(ITEMS_DB[d.id].name); } });
      if (drops.length) setTimeout(() => notify(`üì¶ ${drops.join(", ")} ÌöçÎìù!`), 1000);
      const goldDrop = Math.floor(Math.random()*m.exp)+5;
      gameState.gold += goldDrop;
      gainExp(m.exp);
      gameState.fieldMonsters.splice(monIdx, 1);
      saveGame();
    } else {
      setTimeout(() => {
        if (gameState.screen !== "field") return;
        const mDmg = Math.max(1, m.atk - Math.floor(s.def/2) - Math.floor(Math.random()*2));
        gameState.player.hp = Math.max(0, gameState.player.hp - mDmg);
        showDamageNumber(fp.x * TILE + TILE/2, fp.y * TILE, mDmg, true);
        if (gameState.player.hp <= 0) {
          notify("üíÄ Ïì∞Îü¨Ï°åÎã§...");
          setTimeout(() => { gameState.player.hp = Math.floor(gameState.player.maxHp/2); showScreen("village"); }, 1000);
        }
        updateHUD();
      }, 250);
    }
    updateHUD();
  }

  const attackAnim = setInterval(() => {
    gameState.attackFrame++;
    if (gameState.attackFrame >= 8) {
      gameState.attacking = false;
      gameState.attackFrame = 0;
      clearInterval(attackAnim);
    }
  }, 35);
}

function showDamageNumber(x, y, damage, isPlayer = false) {
  const rect = canvas.getBoundingClientRect();
  const el = document.createElement("div");
  el.className = "damage-number";
  el.textContent = `-${damage}`;
  el.style.left = `${rect.left + x}px`;
  el.style.top = `${rect.top + y}px`;
  el.style.color = isPlayer ? "#FF6B6B" : "#FFD700";
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}

// ============== COMBAT ==============
function startCombat(monster) {
  gameState.combat = { monster:{...monster}, playerTurn:true };
  gameState.combatLog = [`‚öîÔ∏è ${monster.name}(Ïù¥)Í∞Ä ÎÇòÌÉÄÎÇ¨Îã§!`];
  if (monster.isSecretBoss) {
    gameState.combatLog.push(`‚ú® ÎπÑÎ∞Ä Î≥¥Ïä§! Îçî Í∞ïÎ†•Ìï©ÎãàÎã§!`);
  }
  showScreen("combat");
  renderCombat();
}

function renderCombat() {
  const c = gameState.combat; if (!c) return;
  const m = c.monster; const p = gameState.player;
  const zone = FIELD_ZONES[gameState.currentZone];

  document.getElementById("combat-screen").style.background = `linear-gradient(180deg, ${zone.bg}, #1a1a2e)`;

  document.getElementById("combat-monster").innerHTML = "";
  const mCanvas = document.getElementById("combat-monster-canvas");
  const mCtx = mCanvas.getContext("2d");
  mCtx.clearRect(0, 0, 80, 80);
  const mSprite = getMonsterSprite(m.id);
  if (mSprite) drawPixelSpriteOnCanvas(mCtx, mSprite, 0, 0, 10);

  document.getElementById("combat-monster-info").innerHTML = `
    <div style="font-size:16px; font-weight:bold; color:${m.isSecretBoss ? '#FFD700' : '#fff'}">${m.isSecretBoss ? '‚≠ê' : ''}${m.name}${m.isSecretBoss ? '‚≠ê' : ''}</div>
    <div class="hp-bar" style="margin:4px auto; width:140px"><div class="hp-fill" style="width:${(m.currentHp/m.hp)*100}%; background:${m.currentHp/m.hp > 0.5 ? '#4CAF50' : '#f44'}"></div></div>
    <div style="font-size:11px; color:#aaa">HP ${m.currentHp}/${m.hp}</div>
  `;

  const pCanvas = document.getElementById("combat-player-canvas");
  const pCtx = pCanvas.getContext("2d");
  pCtx.clearRect(0, 0, 80, 80);
  drawPixelSpriteOnCanvas(pCtx, getPlayerSprite(), 0, 0, 10);
  const wId = gameState.equipped.weapon;
  if (wId && WEAPON_SPRITES[wId]) drawPixelSpriteOnCanvas(pCtx, WEAPON_SPRITES[wId], 52, 18, 5);

  const logEl = document.getElementById("combat-log");
  logEl.innerHTML = gameState.combatLog.slice(-4).map((l,i,arr) =>
    `<div style="color:${i===arr.length-1 ? '#FFD700' : '#ccc'}">${l}</div>`
  ).join("");
  logEl.scrollTop = logEl.scrollHeight;

  const btnsEl = document.getElementById("combat-btns");
  if (m.currentHp > 0 && p.hp > 0) {
    btnsEl.innerHTML = `
      <button class="action-btn" style="background:#e74c3c" onclick="combatAttack()">‚öîÔ∏èÍ≥µÍ≤©</button>
      <button class="action-btn" style="background:#27ae60" onclick="combatHeal()">üçñÌöåÎ≥µ</button>
      <button class="action-btn" style="background:#3498db" onclick="combatRun()">üèÉÎèÑÎßù</button>
    `;
  } else {
    btnsEl.innerHTML = "";
  }
  updateHUD();
}

function combatAttack() {
  const c = gameState.combat; if (!c || !c.playerTurn) return;
  const s = getStats();
  const dmg = Math.max(1, s.atk - Math.floor(Math.random()*2));
  c.monster.currentHp = Math.max(0, c.monster.currentHp - dmg);
  gameState.combatLog.push(`üó°Ô∏è ${dmg} Îç∞ÎØ∏ÏßÄ!`);

  const mCanvas = document.getElementById("combat-monster-canvas");
  if (mCanvas) { mCanvas.style.transform = "scale(0.9)"; setTimeout(() => mCanvas.style.transform = "scale(1)", 100); }

  if (c.monster.currentHp <= 0) {
    const expBonus = c.monster.isSecretBoss ? Math.floor(c.monster.exp * 0.5) : 0;
    gameState.combatLog.push(`üéâ ${c.monster.name} Ï≤òÏπò! +${c.monster.exp + expBonus} Í≤ΩÌóòÏπò`);
    const drops = [];
    c.monster.drops.forEach(d => {
      const chance = c.monster.isSecretBoss ? Math.min(1, d.chance * 1.5) : d.chance;
      if (Math.random() < chance) { addItem(d.id); drops.push(ITEMS_DB[d.id].name); }
    });
    if (drops.length) gameState.combatLog.push(`üì¶ ÌöçÎìù: ${drops.join(", ")}`);
    const goldDrop = Math.floor(Math.random()*c.monster.exp)+5 + (c.monster.isSecretBoss ? 20 : 0);
    gameState.gold += goldDrop;
    gameState.combatLog.push(`üí∞ +${goldDrop} Í≥®Îìú`);
    gainExp(c.monster.exp + expBonus);
    gameState.fieldMonsters = gameState.fieldMonsters.filter(fm => fm.key !== c.monster.key);
    renderCombat();
    setTimeout(() => { saveGame(); showScreen("field"); }, 1500);
    return;
  }

  const mDmg = Math.max(1, c.monster.atk - Math.floor(s.def/2) - Math.floor(Math.random()*2));
  gameState.player.hp = Math.max(0, gameState.player.hp - mDmg);
  gameState.combatLog.push(`üí• ${c.monster.name}Ïùò Î∞òÍ≤©! -${mDmg} HP`);

  if (gameState.player.hp <= 0) {
    gameState.combatLog.push("üíÄ Ïì∞Îü¨Ï°åÎã§...");
    renderCombat();
    setTimeout(() => { gameState.player.hp = Math.floor(gameState.player.maxHp/2); showScreen("village"); }, 2000);
    return;
  }
  renderCombat();
}

function combatHeal() {
  const foods = Object.entries(gameState.inventory).filter(([id]) => ITEMS_DB[id]?.type === "food");
  if (!foods.length) { notify("ÏùåÏãùÏù¥ ÏóÜÏäµÎãàÎã§!"); return; }
  const [id] = foods[0]; const item = ITEMS_DB[id];
  removeItem(id);
  gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.heal);
  gameState.combatLog.push(`${item.emoji} ${item.name} ÏÇ¨Ïö©! +${item.heal} HP`);
  renderCombat();
}

function combatRun() {
  const runChance = gameState.combat.monster.isSecretBoss ? 0.4 : 0.7;
  if (Math.random() < runChance) { showScreen("field"); notify("ÎèÑÎßùÏ≥§Îã§!"); }
  else {
    const s = getStats();
    const mDmg = Math.max(1, gameState.combat.monster.atk - Math.floor(s.def/2));
    gameState.player.hp = Math.max(0, gameState.player.hp - mDmg);
    gameState.combatLog.push("ÎèÑÎßù Ïã§Ìå®!", `üí• -${mDmg} HP`);
    if (gameState.player.hp <= 0) {
      gameState.combatLog.push("üíÄ Ïì∞Îü¨Ï°åÎã§...");
      renderCombat();
      setTimeout(() => { gameState.player.hp = Math.floor(gameState.player.maxHp/2); showScreen("village"); }, 2000);
      return;
    }
    renderCombat();
  }
}

// ============== MENUS ==============
function openMenu(type) {
  const el = document.getElementById("modal-overlay");
  const content = document.getElementById("modal-content");
  el.classList.remove("hidden");

  if (type === "field_select") {
    content.innerHTML = `<h3>üó∫Ô∏è Ïñ¥ÎîîÎ°ú Í∞àÍπåÏöî?</h3>` +
      FIELD_ZONES.map((z,i) => `
        <button class="zone-btn" style="opacity:${gameState.player.level >= z.minLv ? 1 : 0.4}" onclick="goToField(${i})">
          <span style="font-size:20px">${z.emoji}</span>
          <div><div style="font-weight:bold; font-size:13px">${z.name}</div>
          <div style="font-size:10px;color:#aaa">Lv.${z.minLv}+ | ${z.monsters.map(m=>MONSTERS[m].emoji).join("")}</div></div>
        </button>
      `).join("");
  }
  else if (type === "inventory") {
    const entries = Object.entries(gameState.inventory);
    content.innerHTML = `<h3>üéí Í∞ÄÎ∞©</h3>` + (!entries.length ? '<p style="color:#888; font-size:13px">ÎπÑÏñ¥ÏûàÏäµÎãàÎã§</p>' :
      entries.map(([id,count]) => {
        const item = ITEMS_DB[id]; if (!item) return "";
        let btns = "";
        if (item.type==="food") btns = `<button class="sm-btn" style="background:#27ae60" onclick="useFood('${id}')">ÏÇ¨Ïö©</button>`;
        if (["weapon","shield","armor","shoes","accessory"].includes(item.type)) btns = `<button class="sm-btn" style="background:#3498db" onclick="equipItem('${id}')">Ïû•Ï∞©</button>`;
        return `<div class="item-row"><span class="emoji">${item.emoji}</span><div class="info"><div>${item.name} <span style="color:#888">x${count}</span></div><div class="desc">${item.desc}</div></div>${btns}</div>`;
      }).join(""));
  }
  else if (type === "equip") {
    const s = getStats();
    content.innerHTML = `<h3>‚öîÔ∏è Ïû•ÎπÑ</h3><div style="font-size:13px;color:#FFD700;margin-bottom:10px">Í≥µÍ≤©Î†•: ${s.atk} | Î∞©Ïñ¥Î†•: ${s.def}</div>` +
      [["weapon","‚öîÔ∏è Î¨¥Í∏∞"],["shield","üõ°Ô∏è Î∞©Ìå®"],["armor","ü¶∫ Í∞ëÏò∑"],["shoes","üëü Ïã†Î∞ú"],["accessory","üíç Ïû•Ïã†Íµ¨"]].map(([slot,label]) => {
        const id = gameState.equipped[slot];
        return `<div class="item-row"><span style="font-size:12px;color:#aaa;width:70px">${label}</span>${
          id ? `<span class="emoji">${ITEMS_DB[id].emoji}</span><span style="flex:1;font-size:13px">${ITEMS_DB[id].name}</span><button class="sm-btn" style="background:#e74c3c" onclick="unequipItem('${slot}')">Ìï¥Ï†ú</button>`
          : '<span style="color:#555;font-size:12px;flex:1">‚Äî ÏóÜÏùå ‚Äî</span>'
        }</div>`;
      }).join("");
  }
  else if (type === "status") {
    const p = gameState.player; const s = getStats();
    content.innerHTML = `<h3>üìä ${gameState.playerName}</h3>
      <canvas id="status-char-canvas" width="56" height="56" style="display:block;margin:6px auto;image-rendering:pixelated;"></canvas>` +
      [["Î†àÎ≤®",`Lv.${p.level}`],["HP",`${p.hp}/${p.maxHp}`],["EXP",`${p.exp}/${p.nextExp}`],["Í≥µÍ≤©Î†•",s.atk],["Î∞©Ïñ¥Î†•",s.def]].map(([k,v]) =>
        `<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #333;font-size:13px"><span style="color:#aaa">${k}</span><span style="color:#FFD700">${v}</span></div>`
      ).join("");
    setTimeout(() => {
      const sc = document.getElementById("status-char-canvas");
      if (sc) drawPixelSpriteOnCanvas(sc.getContext("2d"), getPlayerSprite(), 0, 0, 7);
    }, 0);
  }
  else if (type === "home") {
    content.innerHTML = `<h3 style="text-align:center">üè† ÎÇ¥ Ïßë</h3>
      <button class="action-btn" style="background:#27ae60;width:100%;margin-top:10px" onclick="restAtHome()">üí§ Ìú¥Ïãù (Ï≤¥Î†• Ï†ÑÌöåÎ≥µ)</button>`;
  }
  else if (type === "shop") {
    const items = [{id:"apple",price:10},{id:"meat",price:25},{id:"potion",price:60},{id:"herb",price:15}];
    content.innerHTML = `<h3>üè™ ÏÉÅÏ†ê</h3><div style="font-size:13px;color:#FFD700;margin-bottom:10px">üí∞ ${gameState.gold}G</div>` +
      items.map(s => { const item = ITEMS_DB[s.id]; return `<div class="item-row"><span class="emoji">${item.emoji}</span><div class="info"><div>${item.name}</div><div class="desc">${item.desc}</div></div><button class="sm-btn" style="background:#DAA520" onclick="buyItem('${s.id}',${s.price})">${s.price}G</button></div>`; }).join("");
  }
  else if (type === "craft") {
    content.innerHTML = `<h3>üî® Ï†úÏûëÏÜå</h3>` +
      RECIPES.map((r,i) => {
        const item = ITEMS_DB[r.result];
        const canCraft = Object.entries(r.ingredients).every(([id,n]) => (gameState.inventory[id]||0) >= n);
        const ings = Object.entries(r.ingredients).map(([id,n]) => {
          const has = gameState.inventory[id]||0;
          return `<span class="ingredient-tag ${has>=n?'has-enough':'not-enough'}">${ITEMS_DB[id].emoji}${has}/${n}</span>`;
        }).join("");
        return `<div style="padding:6px 0;border-bottom:1px solid #333"><div class="item-row"><span class="emoji">${item.emoji}</span><div class="info"><div style="font-weight:bold;font-size:12px">${r.name}</div><div class="desc">${item.desc}</div></div><button class="sm-btn" style="background:${canCraft?'#8e44ad':'#555'}" onclick="craftItem(${i})">Ï†úÏûë</button></div><div>${ings}</div></div>`;
      }).join("");
  }
}

function closeModal() { document.getElementById("modal-overlay").classList.add("hidden"); }

function useFood(id) {
  const item = ITEMS_DB[id]; if (!item || item.type !== "food") return;
  removeItem(id);
  gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.heal);
  notify(`${item.emoji} ${item.name} +${item.heal} HP`);
  updateHUD(); openMenu("inventory");
}

function equipItem(id) {
  const item = ITEMS_DB[id]; if (!item) return;
  const slotMap = { weapon:"weapon", shield:"shield", armor:"armor", shoes:"shoes", accessory:"accessory" };
  let slot = slotMap[item.type];
  if (!slot) return;
  if (gameState.equipped[slot]) addItem(gameState.equipped[slot]);
  removeItem(id);
  gameState.equipped[slot] = id;
  notify(`${item.emoji} ${item.name} Ïû•Ï∞©!`);
  updateHUD(); openMenu("inventory");
}

function unequipItem(slot) {
  if (gameState.equipped[slot]) {
    addItem(gameState.equipped[slot]);
    gameState.equipped[slot] = null;
    updateHUD(); openMenu("equip");
  }
}

function restAtHome() {
  gameState.player.hp = gameState.player.maxHp;
  notify("üí§ Ï≤¥Î†• ÌöåÎ≥µ!"); updateHUD(); closeModal();
}

function buyItem(id, price) {
  if (gameState.gold < price) { notify("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!"); return; }
  gameState.gold -= price; addItem(id);
  notify(`${ITEMS_DB[id].emoji} ${ITEMS_DB[id].name} Íµ¨Îß§!`);
  updateHUD(); openMenu("shop");
}

function craftItem(idx) {
  const r = RECIPES[idx];
  for (const [id,n] of Object.entries(r.ingredients)) {
    if ((gameState.inventory[id]||0) < n) { notify("Ïû¨Î£åÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!"); return; }
  }
  for (const [id,n] of Object.entries(r.ingredients)) removeItem(id, n);
  addItem(r.result);
  notify(`‚ú® ${r.name} Ï†úÏûë!`);
  updateHUD(); openMenu("craft");
}

// ============== KEYBOARD ==============
window.addEventListener("keydown", (e) => {
  // ÌÄ¥Ï¶à ÏûÖÎ†• Ï§ëÏù¥Î©¥ Î¨¥Ïãú
  if (document.activeElement?.id === 'quiz-answer') {
    if (e.key === 'Enter') submitQuizAnswer();
    return;
  }

  if (e.key === " " || e.key === "Enter") {
    e.preventDefault();
    fieldAttack();
    return;
  }

  const map = { ArrowUp:[0,-1], ArrowDown:[0,1], ArrowLeft:[-1,0], ArrowRight:[1,0], w:[0,-1], s:[0,1], a:[-1,0], d:[1,0] };
  const dir = map[e.key]; if (!dir) return;
  e.preventDefault();
  movePlayer(dir[0], dir[1]);
});

// ============== COLOR PICKER ==============
function initColorPickers() {
  const hairPicker = document.getElementById('hair-colors');
  const clothesPicker = document.getElementById('clothes-colors');
  const shoesPicker = document.getElementById('shoes-colors');

  HAIR_COLORS.forEach(color => {
    const btn = document.createElement('div');
    btn.className = 'color-btn' + (color === customColors.hair ? ' selected' : '');
    btn.style.background = color;
    btn.onclick = () => {
      customColors.hair = color;
      document.querySelectorAll('#hair-colors .color-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      updateCharPreviews();
    };
    hairPicker.appendChild(btn);
  });

  CLOTHES_COLORS.forEach(color => {
    const btn = document.createElement('div');
    btn.className = 'color-btn' + (color === customColors.clothes ? ' selected' : '');
    btn.style.background = color;
    btn.onclick = () => {
      customColors.clothes = color;
      document.querySelectorAll('#clothes-colors .color-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      updateCharPreviews();
    };
    clothesPicker.appendChild(btn);
  });

  SHOES_COLORS.forEach(color => {
    const btn = document.createElement('div');
    btn.className = 'color-btn' + (color === customColors.shoes ? ' selected' : '');
    btn.style.background = color;
    btn.onclick = () => {
      customColors.shoes = color;
      document.querySelectorAll('#shoes-colors .color-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      updateCharPreviews();
    };
    shoesPicker.appendChild(btn);
  });
}

function updateCharPreviews() {
  const boyCanvas = document.getElementById("char-preview-boy");
  const girlCanvas = document.getElementById("char-preview-girl");
  if (boyCanvas && girlCanvas) {
    const boyCtx = boyCanvas.getContext("2d");
    const girlCtx = girlCanvas.getContext("2d");
    boyCtx.clearRect(0, 0, 48, 48);
    girlCtx.clearRect(0, 0, 48, 48);
    drawPixelSpriteOnCanvas(boyCtx, generatePlayerSprite('boy', customColors.hair, customColors.clothes, customColors.shoes), 0, 0, 6);
    drawPixelSpriteOnCanvas(girlCtx, generatePlayerSprite('girl', customColors.hair, customColors.clothes, customColors.shoes), 0, 0, 6);
  }
}

// ============== INIT ==============
function gameLoop() {
  if (gameState.screen === "village" || gameState.screen === "field") render();
  requestAnimationFrame(gameLoop);
}
gameLoop();

window.addEventListener("DOMContentLoaded", () => {
  initColorPickers();
  updateCharPreviews();
  renderSavedChars();
});
</script>
</body>
</html>
